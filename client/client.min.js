var sound,cover,tag="v0.9.3",proto=window.location.protocol,host=window.location.host,port=window.location.port,oport=0,els={},facetdivs=[],artistdivs=[],trks=[],trkInfo=[],trkIdx=0,filterMeta=[],playing="no",shuffle=!1,shflHist=[],mobile=!1,elnames=["facetlist","artistlist","artistfilter","filter","main","maintable","cover","tracklist","curtitle","curaay","curfacets","curnum","vol","shuffle","help","searchhelp","searchhelpbut","player","trkinfo","coverbig","coverbigdiv"];elnames.forEach(e=>els[e]=document.getElementById(e)),window.addEventListener("keydown",e=>handleKey(e)),setInterval(pingHost,2e4);async function pingHost(){try{const e=await fetch(`${proto}//${host}:${port}/ping`).then(e=>e.json())}catch(e){errorHandler(-1,e,{type:"ping",i:trkIdx})}}async function initThrasher(e){e=="mobile"&&(mobile=!0,checkOrientation());const n=/["'& ]/g,t=await fetch(`${proto}//${host}/init`).then(e=>e.json());listen=t.meta[0],host=t.meta[1],port=t.meta[2],oport=t.meta[3],console.log(t.meta,listen,host,port),t.facets.forEach(e=>{const t=e.replaceAll(n,"");els.facetlist.insertAdjacentHTML("beforeend",`<div id="fd${t}"><input type="checkbox" id="fc${t}" value="${e}" onClick="buildCheckQuery(this);" /><label for="fc${t}">${e}</label></div>`),facetdivs.push(document.getElementById(`fd${t}`))}),mobile||(t.artists.forEach(e=>{let t=e.replaceAll(n,"");e=e.replaceAll(/"/g,"&quot;"),els.artistlist.insertAdjacentHTML("beforeend",`<div id="ad${t}"><input type="checkbox" id="ac${t}" value="${e}" onClick="buildCheckQuery(this);" /><label for="ac${t}">${e}</label></div>`),artistdivs.push(document.getElementById(`ad${t}`))}),els.facetlist.style.height=els.facetlist.parentNode.clientHeight-els.facetlist.previousElementSibling.clientHeight+"px",els.artistlist.style.height=els.artistlist.parentNode.clientHeight-els.artistlist.previousElementSibling.clientHeight-els.artistlist.previousElementSibling.previousElementSibling.clientHeight+"px",els.tracklist.style.height=els.tracklist.parentNode.clientHeight-els.tracklist.previousElementSibling.clientHeight+"px"),setInterval(isPlaying,333),setFilterNet("a:a\\\\b",!0)}function handleKey(e){if(els.filter===document.activeElement||els.artistfilter===document.activeElement)return;switch(e.key){case"?":case"h":helpPopup("help");break;case"v":showVersion();break;case" ":playPause();break;case"p":playPrev();break;case"n":playNext();break;case"ArrowRight":soundSeek(10);break;case"ArrowLeft":soundSeek(-10);break;case"r":queryRecent();break;case"s":shuffleMode();break;case"u":case"c":uncheckAll();break;case"`":case"m":els.vol.value=0,setVol();break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":els.vol.value=e.key*10,setVol();break;case"0":els.vol.value=100,setVol();break}}async function setFilter(e){if(e.key!="Enter")return;setFilterNet(els.filter.value),document.activeElement.blur()}async function setFilterNet(e,t){e=e.replaceAll(/\//g,"%2F");let n=`${proto}//${host}:${port}/f/${e}`;if(n=encodeURI(n),console.log(e,n),filterMeta=await fetch(n).then(e=>e.json()),filterMeta.Err!=""){errorHandler(-1,filterMeta.Err,{type:"filter",i:trkIdx});return}filterMeta.FltrCount==0&&(playing=="auto"?playing="single":Function.prototype(),trks=[]),t?showVersion():getTrks("y,b,n")}async function queryRecent(){mobile||(els.filter.value="");let e=`${proto}//${host}:${port}/qr`;e=encodeURI(e),filterMeta=await fetch(e).then(e=>e.json()),console.log(filterMeta),getTrks("recent")}async function getTrks(e){trks=[],n=els.maintable.firstChild,n.replaceChildren(),trkInfo=[],shflHist=[],i=0,o=0;let t="",s="",a="";for(var n;o<filterMeta.FltrCount;){const r=`${proto}//${host}:${port}/i/batch/${e}/${o}`;qb=await fetch(encodeURI(r)).then(e=>e.json()),trks.push(...qb.Trks);for(const e of qb.TIs)e.Album!=a&&(a=e.Album,t=="track"?(t="track2",s="trackf2"):(t="track",s="trackf")),e.Title.length>70&&(e.Title=`${e.Title.substring(0,69)}…`),e.Artist.length>70&&(e.Artist=`${e.Artist.substring(0,69)}…`),trkInfo.push(e),n.insertAdjacentHTML("beforeend",`<tr class="${t}" id="trk${i}" onClick="playTrk(${i});"><td>${e.Num}</td><td>${e.Title}</td><td>${e.Artist}</td><td>${e.Album}</td><td>${e.Year}</td></tr><tr class="${s}" onClick="playTrk(${i});"><td style="background-color: #556"></td><td colspan="4">${expandFacets(i)}</td></tr>`),i++;o=o+100}alertify.message(`${filterMeta.FltrCount} tracks in queue`),playing=="single"?playing="auto":Function.prototype(),playing=="auto"?trkIdx=-1:trkIdx=0}function buildCheckQuery(e){e.blur();let t="";for(const e of[artistdivs,facetdivs])e.forEach(e=>{const n=e.firstChild;n.checked&&(e.id.startsWith("ad")?t=`${t}a:${n.value}||`:t=`${t}f:${n.value}||`)});t=t.replace(/\|\|$/,""),t==""&&(t="a:=a\\\\=b"),setFilterNet(t)}function uncheckAll(){let t=0;for(const e of[artistdivs,facetdivs])e.forEach(e=>{e.firstChild.checked&&(e.firstChild.checked=!1,t++)});mobile||(els.artistfilter.value="",filterArtists(null),els.filter.value=""),setFilterNet("a:=a\\\\=b")}function playTrk(e){unsetHighlight(trkIdx),playing="no",trkIdx=e;var t=encodeURIComponent(trks[e]),t=t.replaceAll("%2F","/");const n=`${proto}//${host}:${port}/music${t}`;sound!=null&&sound.stop(),sound=new Howl({src:[n],html5:!0}),sound.once("loaderror",(e,t)=>{errorHandler(e,t,{type:"load",url:n})}),sound.once("playerror",(e,t)=>{errorHandler(e,t,{type:"load",url:n})}),sound.once("load",()=>{updateCurrent();const e=document.getElementById("curdur");e.replaceChildren(),e.insertAdjacentHTML("beforeend",formatTime(Math.floor(sound.duration()))),playing="auto"}),setVol(),sound.play(),setHighlight(trkIdx),mobile||displayCover()}async function startPlaying(){if(trks.length==0)return;if(sound==null)shuffle&&(trkIdx=getNextIdx()),playTrk(trkIdx);else{if(playing=="auto"||playing=="single"){const e=sound.seek();await new Promise(e=>setTimeout(e,150));const t=sound.seek();if(e==t){sound.pause(),sound.play();return}return}sound.play(),filterMeta.FltrCount>1?playing="auto":playing="single"}}function stopPlaying(){sound!=null&&(playing="paused",sound.pause())}function playNext(){if(playing="no",!shuffle&&trkIdx>=trks.length-1)return;if(unsetHighlight(trkIdx),trkIdx=getNextIdx(),trkIdx==-1)return;playTrk(trkIdx)}function playPrev(){if(playing="no",trkIdx<=0||trks.length==0)return;unsetHighlight(trkIdx),trkIdx--,playTrk(trkIdx)}function playPause(){playing=="auto"||playing=="single"?stopPlaying():startPlaying()}function isPlaying(){if(sound==null)return;if(playing=="no"||playing=="paused")return;if(sound.playing())time=document.getElementById("curtime"),time.replaceChildren(),time.insertAdjacentHTML("beforeend",formatTime(Math.floor(sound.seek())));else if(playing=="auto"){playNext();return}}function soundSeek(e){var t=sound.seek()+e;if(console.log(e,sound.seek(),t),t<0){sound.seek(0);return}if(maxPos=sound.duration(),t>maxPos){sound.seek(maxPos);return}sound.seek(t)}function setVol(e){if(sound==null)return;e==null?sound.volume(els.vol.value/100):sound.volume(e/100)}function shuffleMode(){if(shuffle){shuffle=!1,toggleButtonColor("shuffle");return}shuffle=!0,toggleButtonColor("shuffle")}function getNextIdx(){if(!shuffle)return trkIdx+1;let t=!1,e=Math.floor(Math.random()*trks.length);for(;shflHist.includes(e);){if(shflHist.length==trks.length-1){t=!0;break}e=Math.floor(Math.random()*trks.length)}return t?(shuffleMode(),playing="no",alertify.message(`Every track in queue has been played; ending shuffle`),-1):(shflHist.push(e),shflHist.length>50&&shflHist.shift(),e)}async function displayCover(){var e=trks[trkIdx].split("/");e.pop(),e=encodeURIComponent(e.join("/")),e=e.replaceAll("%2F","/");const t=`${proto}//${host}:${port}/music${e}/cover.jpg`;if(cover==t)return;const n=await fetch(t,{method:"HEAD"}).then(e=>e.status);n==200?(els.cover.src=t,els.coverbig.src=t):(els.cover.src="",els.coverbig.src=""),cover=t}function popCover(){els.coverbigdiv.style.display=="none"?els.coverbigdiv.style.display="block":els.coverbigdiv.style.display="none"}function filterArtists(e){if(e!=null&&e.key=="Escape"){document.activeElement.blur();return}const t=els.artistfilter.value.toLowerCase();for(const[n,e]of Object.entries(artistdivs))e.textContent.toLowerCase().includes(t)?e.style.display="block":e.style.display="none"}function showVersion(){alertify.message(`<b>Thrasher ${tag}</b><br/>${filterMeta.TrackCount} tracks in catalog`),mobile||alertify.message(`Press '?' for keyboard mappings`)}function helpPopup(e,t){toggleButtonColor(t),els[e].style.display=="block"?els[e].style.display="none":els[e].style.display="block"}function toggleButtonColor(e){if(els[e]==null)return;els[e].nodeName=="BUTTON"&&(window.getComputedStyle(els[e]).backgroundColor=="rgb(187, 187, 187)"?els[e].style.backgroundColor="#cec":els[e].style.backgroundColor="#bbb")}function formatTime(e){var t=Math.floor(e/60)||0,n=e-t*60||0;return t+":"+(n<10?"0":"")+n}function expandFacets(e){let n=[],t="";try{n=JSON.parse(trkInfo[e].Facets)}catch{return t}return n.forEach(e=>{t=`${t}${e}, `}),t=t.slice(0,-2),t}function updateCurrent(){els.curtitle.replaceChildren(),els.curaay.replaceChildren(),els.curfacets.replaceChildren(),els.curnum.replaceChildren(),els.curtitle.insertAdjacentHTML("beforeend",`${trkInfo[trkIdx].Title}`),els.curaay.insertAdjacentHTML("beforeend",`${trkInfo[trkIdx].Artist} / ${trkInfo[trkIdx].Album} (${trkInfo[trkIdx].Year})`),els.curnum.insertAdjacentHTML("beforeend",`${trkIdx+1} of ${filterMeta.FltrCount} / <span class="monotime"><span id="curtime"></span> (<span id="curdur"></span>)</span>`),els.curfacets.insertAdjacentHTML("beforeend",`${expandFacets(trkIdx)}`),document.title=`${trkInfo[trkIdx].Title} by ${trkInfo[trkIdx].Artist}`}function unsetHighlight(e){if(e==-1)return;try{let t=document.getElementById(`trk${e}`);for(const e of t.childNodes)t.className=="track"||t.className=="trackf"?e.style.backgroundColor="#aab":e.style.backgroundColor="#ccd";t.className=="track"||t.className=="trackf"?t.nextSibling.childNodes[1].style.backgroundColor="#aab":t.nextSibling.childNodes[1].style.backgroundColor="#ccd"}catch{errorHandler(sound.id,"couldn't grab old tr",{type:"hilite",i:e})}}function setHighlight(e){try{let t=document.getElementById(`trk${e}`);for(const e of t.childNodes)e.style.backgroundColor="#bbe";t.nextSibling.childNodes[1].style.backgroundColor="#bbe",t.scrollIntoView({block:"center"})}catch{errorHandler(sound.id,"couldn't grab new tr",{type:"hilite",i:e})}}function errorHandler(e,t,n){n.type=="load"?(console.log(`file load error: id '${e}', err '${t}', playing ${playing}, x: ${n}`),playNext()):n.type=="play"?(playing="no",alertify.alert().setting({title:"Playback error",label:"Click to reload",message:`Autoplay halted.<br/><br/>Dismiss this alert to reload Thrasher`,modal:!0,onok:function(){reloadPage("")}}).show()):n.type=="ping"?(playing="no",alertify.alert().setting({title:"Network error",label:"Click to reload",message:`Autoplay halted.<br/>Error: ${t}<br/><br/>Dismiss this alert to reload Thrasher`,modal:!0,onok:function(){reloadPage("")}}).show()):n.type=="filter"?(playing="no",alertify.alert().setting({title:"Filter error",label:"Ok",message:`A malformed filter was specified: ${t}<br/><br/>Click the [?] button in the footer for an explanation of filters.`,modal:!0}).show()):(console.log(`thrasher err: id '${e}', err '${t}', playing ${playing}, x: ${n}`),playNext())}function reloadPage(e){window.location.replace(`${proto}//${host}:${oport}/${e}`)}