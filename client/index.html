<!DOCTYPE html>
<html>
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Semi+Condensed:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/AlertifyJS/1.13.1/css/alertify.min.css" integrity="sha512-IXuoq1aFd2wXs4NqGskwX2Vb+I8UJ+tGJEu/Dc0zwLNKeQ7CW3Sr6v0yU3z5OQWe3eScVIkER4J9L7byrgR/fA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/AlertifyJS/1.13.1/css/themes/default.min.css" integrity="sha512-RgUjDpwjEDzAb7nkShizCCJ+QTSLIiJO1ldtuxzs0UIBRH4QpOjUU9w47AF9ZlviqV/dOFGWF6o7l3lttEFb6g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
      html { height: 99%; }
      body { height: 99%;
             background-color: #333;
             border: medium solid #556;
             margin: 0;
           }
      #container { display: grid;
                   grid-template-columns: 1fr 3fr;
                   grid-template-rows: 1fr 1fr 2em;
                   height: 98vh;
                 }

      #facets {
          background-color: #aab;
          grid-row-start: 1;
          grid-row-end: 2;
          border-right: medium solid #556;
          overflow: hidden;
          font-family: "Lato", sans-serif;
      }
      #facetlist {overflow: scroll;}

      #artists {
          background-color: #aab;
          grid-row-start: 2;
          grid-row-end: 3;
          border-top: medium solid #556;
          border-right: medium solid #556;
          overflow: hidden;
          font-family: "Lato", sans-serif;
      }
      #artistlist {overflow: scroll;}

      #main { grid-row-start: 1;
              grid-row-end: 3;
              background-color: #556;
              overflow: hidden;
              font-family: "Lato", sans-serif;
            }

      #player { font-family: "Barlow Semi Condensed";
                font-weight: 400;
                font-size: x-large;
                background-color: #bbd;
                padding: 0.15em;
                height: 5em;
      }

      #foot { grid-column-start: 1;
              grid-column-end: 3;
              background-color: #bbd;
              border-top: medium solid #556;
              font-family: "Barlow Semi Condensed";
              font-weight: 400;
              font-size: large;
              padding-left: 0.3em;
              padding-bottom: 0.2em;
            }

      .title { font-family: "Barlow Semi Condensed";
               font-weight: 400;
               font-size: x-large;
               background-color: #bbd;
               padding: 0.15em;
             }

      .listfilter { padding: .2em;
                    background-color: #cce;
                    font-family: "Barlow Semi Condensed";
                    font-weight: 400;
                  }

      .track { color: #000;
               padding-top: 0.5em;
               margin-bottom: 0.5em;
             }

      #tracklist { overflow: scroll; }

      #maintable { width: 100%;
                   margin: 0;
                   border-spacing: 0 0;
                 }


      .track td { background-color: #bbc;
                  padding: 0.2em;
                  border-top: medium solid #556;
                }

      .trackf td { background-color: #bbc;
                   padding: 0.3em;
                   font-size: small;
                   border-bottom: thick solid #556;
                 }

      input { font-family: monospace;
              background-color: #eee;
              border: thin solid #556;
              border-radius: 0.25em;
            }

      h2 { margin-top: 0; margin-right: 0.7em; margin-bottom: 0.5em; font-weight: 400; }

      #buttonbox { background-color: #444;
                   padding-top: 0;
                   padding-bottom: 0.3em;
                   padding-left: 0.3em;
                   padding-right: 0.3em;
                   margin-right: 0.3em;
                   border: solid thin #556;
                   border-radius: 0.25em;
                 }

      #current { border-left: solid medium #556;
                 margin-left: 1em;
                 padding-left: 1em;
                 vertical-align: top;
               }
      #curtitle { margin-top: 0.2em;}
      #curaay {font-size: large;
               margin-bottom: 0;
               padding-bottom: 0;
              }
      #curfacets { font-size: large;
                   margin-bottom: 0;
                   padding-bottom: 0;
                 }
      #curnum { font-size: large;
                margin-bottom: 0;
                padding-bottom: 0;
              }


      #fdata { margin-left: 2em; }

      .alertify-notifier.ajs-right .ajs-message.ajs-visible { background-color: #99a !important;
                                                              border: solid medium #556;
                                                            }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="facets">
        <div class="title">Facets</div>
        <div id="facetlist"></div>
      </div>
      <div id="artists">
        <div class="title">Artists</div>
        <div class="listfilter">Filter <input id="artistfilter" onKeyUp="filterArtists();" /></div>
        <div id="artistlist"></div>
      </div>
      <div id="main">
        <div id="player">
          <table><tbody>
              <tr>
                <td><h2>Shawnify</h2></td>
                <td id="current" rowspan="2">
                  <div id="curtitle">This is where</div>
                  <div id="curaay">current track info</div>
                  <div id="curfacets">will go</div>
                  <div id="curnum"></div>
                </td>
              </tr>
              <tr><td style="vertical-align: top;">
                  <span id="buttonbox">
                    <button id="prevbtn" onClick="playPrev();">‚èÆ</button>
                    <button id="playbtn" onClick="startPlaying();">‚èµ</button>
                    <button id="stopbtn" onClick="stopPlaying();">‚è∏</button>
                    <button id="nextbtn" onClick="playNext();">‚è≠</button>
                    <!-- <button id="shuflbtn" onClick="toglShufl();">üîÄ</button> -->
                  </span>
              </td></tr>
          </tbody></table>
        </div>
        <div id="tracklist">
          <table id="maintable"><tbody></tbody></table>
        </div>
      </div>
      <div id="foot">
        Search <input id="filter" type="text" size="40" onKeyUp="setFilter(event);"></input>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.core.min.js" integrity="sha512-d00Brs/+XQUUaO0Y9Uo8Vw63o7kS6ZcLM2P++17kALrI8oihAfL4pl1jQObeRBgv06j7xG0GHOhudAW0BdrycA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/AlertifyJS/1.13.1/alertify.min.js" integrity="sha512-JnjG+Wt53GspUQXQhc+c4j8SBERsgJAoHeehagKHlxQN+MtCCmFDghX9/AcbkkNRZptyZU4zC8utK59M5L45Iw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
      var host = "10.1.10.210:8080";
      var els = {};
      var facetdivs = [];
      var artistdivs = [];
      var trks = [];
      var trkInfo = [];
      var trkIdx = 0;
      var filterMeta = [];
      var playing = false;
      var sound;

      var elnames = ["facetlist", "artistlist", "artistfilter", "filter", "main", "maintable", "tracklist", "curtitle", "curaay", "curfacets", "curnum"];
      elnames.forEach((name) => ( els[name] = document.getElementById(name) ));

      async function setFilter(evt) {
          if (evt.key != "Enter") {
              return;
          }
          setFilterNet(els["filter"].value);
      }

      async function setFilterNet(filter) {
          filter = filter.replaceAll(/\//g, "%2F");
          let url = `http://${host}/f/${filter}`;
          url = encodeURI(url)
          //console.log(url)
          filterMeta = await fetch(url).then((r) => { return r.json() });
          alertify.message(`${filterMeta.FltrCount} selected tracks`);
          if (filterMeta.FltrCount == 0) {
              return
l          }
          getTrks();
      }

      async function getTrks() {
          const url = `http://${host}/q/b,n/0/0`;
          const mt = els["maintable"].firstChild;
          mt.replaceChildren();
          trks = await fetch(encodeURI(url)).then((r) => { return r.json() });
          trkInfo = [];
          i = 0;
          for (const trk of trks) {
              const turl = `http://${host}/i/${trk.replaceAll(/\//g, "%2F")}`;
              ti = await fetch(encodeURI(turl)).then((r) => { return r.json() });
              trkInfo.push(ti);
              mt.insertAdjacentHTML("beforeend", `<tr class="track" onClick="playTrk(${i});"><td>${ti.Num}</td><td>${ti.Title}</td><td>${ti.Artist}</td><td>${ti.Album}</td><td>${ti.Year}</td></tr><tr class="trackf" onClick="playTrk(${i});"><td style="background-color: #556"></td><td colspan="4">${expandFacets(i)}</td></tr>`);
              i++;
          }
      }

      function buildCheckQuery(type) {
          let q = ""
          let el;
          if (type == "artist") {
              el = artistdivs;
              q = "a:"
          } else {
              el = facetdivs;
              q = "f:"
          }
          el.forEach((div) => {
              const box = div.firstChild;
              if (box.checked) {
                  if (q == "a:" || q == "f:") {
                      q = `${q}${box.value}`;
                  } else {
                      q = `${q}//${box.value}`;
                  }
              }
          });
          console.log(type, q);
          if (q == "a:" || q == "f:") {
              q = "a:=a\\\\=b";
              els["maintable"].firstChild.replaceChildren();
          }
          setFilterNet(q);
      }

      function filterArtists() {
          const v = els["artistfilter"].value.toLowerCase();
          for (const [name, div] of Object.entries(artistdivs)) {
              if (div.textContent.toLowerCase().includes(v)) {
                  div.style.display = "block";
              } else {
                  div.style.display = "none";
              }
          }
      }

      function formatTime(secs) {
          var minutes = Math.floor(secs / 60) || 0;
          var seconds = (secs - minutes * 60) || 0;
          return minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
      }

      function expandFacets(i) {
          let fj = [];
          let fs = ""
          try {
              fj = JSON.parse(trkInfo[i].Facets);
          } catch (error) {
              return fs;
          }
          fj.forEach((facet) => { fs = `${fs}${facet}, `; });
          fs = fs.slice(0, -2);
          return fs;
      }

      function updateCurrent() {
          els["curtitle"].replaceChildren();
          els["curaay"].replaceChildren();
          els["curfacets"].replaceChildren();
          els["curnum"].replaceChildren();
          els["curtitle"].insertAdjacentHTML("beforeend", `${trkInfo[trkIdx].Title}`);
          els["curaay"].insertAdjacentHTML("beforeend", `${trkInfo[trkIdx].Artist} / ${trkInfo[trkIdx].Album} / ${trkInfo[trkIdx].Year}`);
          els["curnum"].insertAdjacentHTML("beforeend", `${trkIdx + 1} of ${filterMeta.FltrCount} / <span id="curdur"></span> / <span id="curtime"></span>`);
          els["curfacets"].insertAdjacentHTML("beforeend", `${expandFacets(trkIdx)}`);
      }

      function playTrk(i) {
          trkIdx = i;
          const trkURL = encodeURI(`http://${host}/music/${trks[i]}`);
          if (sound != undefined) {
              sound.stop();
          }
          sound = new Howl({
              src: [trkURL],
              html5: true
          });
          sound.play();
          playing = true;
          updateCurrent();
          sound.once("load", () => {
              const d = document.getElementById("curdur");
              d.replaceChildren();
              d.insertAdjacentHTML("beforeend", formatTime(Math.floor(sound.duration())));
          });
      }

      function startPlaying() {
          if (playing) {
              return
          }
          if (sound != undefined) {
              sound.play();
              playing = true;
          }
      }

      function stopPlaying() {
          if (!playing) {
              return
          }
          if (sound != undefined) {
              sound.pause();
              playing = false;
          }
      }

      function playNext() {
          if (trkIdx == trks.length - 1) {
              return
          }
          if (sound != undefined) {
              sound.stop();
          }
          trkIdx++;
          playTrk(trkIdx);
      }

      function playPrev() {
          if (trkIdx == 0) {
              return
          }
          if (sound != undefined) {
              sound.stop();
          }
          trkIdx--;
          playTrk(trkIdx);
      }

      function isPlaying() {
          if (sound == undefined) {
              return;
          }
          if (!playing) {
              return;
          }
          if (!sound.playing()) {
              // we haven't said stop, but the current track is over
              if (trkIdx == trks.length - 1) {
                  // we played the last track in the queue; nothing to do
                  return;
              }
              trkIdx++;
              playTrk(trkIdx);
              return;
          }
          // playing! update time
          time = document.getElementById("curtime");
          time.replaceChildren();
          time.insertAdjacentHTML("beforeend", formatTime(Math.floor(sound.seek())));
      }

      (async() => {
          const regex = /["'& ]/g;
          const catAF = await fetch(`http://${host}/init`).then((r) => { return r.json() });
          catAF.facets.forEach((facet) => {
              const nfacet = facet.replaceAll(regex, "");
              els["facetlist"].insertAdjacentHTML("beforeend", `<div id="fd${nfacet}"><input type="checkbox" id="fc${nfacet}" value="${facet}" onClick="buildCheckQuery('facet');" /><label for="fc${nfacet}">${facet}</label></div>`);
              facetdivs.push(document.getElementById(`fd${nfacet}`));
          });
          catAF.artists.forEach((artist) => {
              let nartist = artist.replaceAll(regex, "");
              artist = artist.replaceAll(/"/g, "&quot;");
              els["artistlist"].insertAdjacentHTML("beforeend", `<div id="ad${nartist}"><input type="checkbox" id="ac${nartist}" value="${artist}" onClick="buildCheckQuery('artist');" /><label for="ac${nartist}">${artist}</label></div>`);
              artistdivs.push(document.getElementById(`ad${nartist}`));
          });
          // set facetlit height
          els["facetlist"].style.height = (els["facetlist"].parentNode.clientHeight - els["facetlist"].previousElementSibling.clientHeight) + "px";
          // set artistlist height
          els["artistlist"].style.height = (els["artistlist"].parentNode.clientHeight - els["artistlist"].previousElementSibling.clientHeight - els["artistlist"].previousElementSibling.previousElementSibling.clientHeight) + "px";
          // set tracklist height
          els["tracklist"].style.height = (els["tracklist"].parentNode.clientHeight - els["tracklist"].previousElementSibling.clientHeight) + "px";
          // start the isPlaying ticker
          setInterval(isPlaying, 333);
      })();
    </script>
  </body>
</html>
